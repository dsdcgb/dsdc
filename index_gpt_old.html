<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ë‹¬ì„œë””ì§€í„¸ì°½ì‘ì„¼í„° ìŠ¤íƒ¬í”„ íˆ¬ì–´</title>
  <meta name="theme-color" content="#111"/>
  <style>
    :root { --fg:#111; --muted:#6b7280; --bg:#fff; --line:#e5e7eb; --ok:#16a34a; }
    *{box-sizing:border-box} body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:var(--bg);color:var(--fg)}
    header{padding:16px 20px;border-bottom:1px solid var(--line)}
    h1{margin:0;font-size:20px}
    main{padding:16px}
    .card{border:1px solid var(--line);border-radius:16px;padding:16px;box-shadow:0 1px 6px rgba(0,0,0,.06);background:#fff}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .btn{padding:12px 16px;border-radius:12px;border:1px solid var(--fg);cursor:pointer;background:var(--fg);color:#fff}
    .btn.outline{background:#fff;color:var(--fg)}
    .pill{display:inline-block;padding:6px 12px;border-radius:999px;background:#f3f4f6;margin-right:6px}
    .done{background:#e6fbea;color:var(--ok);border:1px solid #86efac}
    .muted{color:var(--muted)}
    video{width:100%;border-radius:12px;background:#000;max-height:48vh}
    #complete{border:2px solid var(--ok)}
    .codebox{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;background:#111;color:#fff;padding:10px;border-radius:8px;overflow:auto}
    .small{font-size:12px}
    .grid2{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    a.link{color:#2563eb;text-decoration:none}
  </style>
  <!-- QR ìŠ¤ìº” ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
  <script src="https://unpkg.com/@zxing/browser@latest"></script>
  <!-- ì™„ì£¼ì½”ë“œ QR ìƒì„±ìš© (ì„ íƒ) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>
  <header>
    <h1>ìŠ¤íƒ¬í”„ íˆ¬ì–´</h1>
  </header>
  <main>
    <div class="card">
      <p class="muted">íŒë“œë¡  Â· VRë ˆì´ì‹± Â· íœ´ë¨¸ë…¸ì´ë“œ Â· ë°°í‹€ë¡œë´‡ 4ê³³ì„ ëª¨ë‘ ìŠ¤ìº”í•˜ë©´ ì™„ì£¼!</p>
      <div id="progress" class="row" aria-live="polite"></div>
      <div class="row" style="margin-top:8px">
        <button id="startBtn" class="btn" type="button">ì¹´ë©”ë¼ ìŠ¤ìº” ì‹œì‘</button>
        <button id="stopBtn" class="btn outline" type="button">ì¤‘ì§€</button>
        <button id="resetBtn" class="btn outline small" type="button" title="ì´ ê¸°ê¸°ì˜ ì§„í–‰ì„ ì´ˆê¸°í™”í•©ë‹ˆë‹¤">ì´ˆê¸°í™”</button>
      </div>
      <p id="notice" class="muted small" style="margin-top:6px">ìŠ¤ìº”í•˜ë ¤ë©´ ì‹œì‘ ë²„íŠ¼ì„ ëˆ„ë¥´ê³ , ê° ì²´í—˜ì¡´ì˜ QRì„ ë¹„ì¶°ì£¼ì„¸ìš”.</p>
    </div>

    <div class="card" style="margin-top:16px">
      <video id="preview" muted playsinline></video>
      <div id="log" class="muted" style="margin-top:8px"></div>
    </div>

    <div id="complete" class="card" style="margin-top:16px;display:none">
      <h2 style="margin-top:0">ì™„ì£¼ ì¶•í•˜í•©ë‹ˆë‹¤! ğŸ‰</h2>
      <div id="stampList" class="grid2" style="margin:10px 0"></div>
      <p class="muted small">ì•„ë˜ì˜ ì™„ì£¼ì½”ë“œë¥¼ ì•ˆë‚´ë°ìŠ¤í¬ì— ì œì‹œí•´ ì£¼ì„¸ìš”.</p>
      <div id="codeText" class="codebox small" style="margin-top:8px"></div>
      <div id="codeQr" style="margin-top:10px"></div>
      <p class="small" style="margin-top:8px">ê²€ì¦ í˜ì´ì§€: <a class="link" href="verify.html" target="_blank" rel="noopener">verify.html</a></p>
    </div>
  </main>

<script>
// ===== ì„¤ì • =====
const STATIONS = [
  { id:'DRONE', label:'íŒë“œë¡ ' },
  { id:'VR', label:'VRë ˆì´ì‹±' },
  { id:'HUMANOID', label:'íœ´ë¨¸ë…¸ì´ë“œ' },
  { id:'BATTLE', label:'ë°°í‹€ë¡œë´‡' },
];
const SALT = 'CHANGE_ME_SALT_32+CHARS'; // ë°°í¬ ì „ì— ì„ì˜ë¡œ ë³€ê²½í•˜ì„¸ìš”(ë‘ í˜ì´ì§€ ë™ì¼ê°’)

// ===== ìƒíƒœ ë° ìœ í‹¸ =====
const state = {
  stamps: new Set(JSON.parse(localStorage.getItem('stamps')||'[]')),
  nonce: localStorage.getItem('nonce') || null,
};
if (!state.nonce){
  state.nonce = crypto.getRandomValues(new Uint32Array(4)).join('-');
  localStorage.setItem('nonce', state.nonce);
}

function saveLocal(){ localStorage.setItem('stamps', JSON.stringify([...state.stamps])); }
function dateKey(d=new Date()){ return new Intl.DateTimeFormat('ko-KR',{timeZone:'Asia/Seoul'}).format(d).replace(/\./g,'-').replace(/\s/g,'').replace(/-$/,''); }

function renderProgress(){
  const wrap = document.getElementById('progress');
  wrap.innerHTML = '';
  STATIONS.forEach(s=>{
    const el = document.createElement('span');
    el.className = 'pill' + (state.stamps.has(s.id) ? ' done' : '') ;
    el.textContent = s.label + (state.stamps.has(s.id)?' âœ“':'');
    wrap.appendChild(el);
  });
}

function parseStamp(text){
  if (!text) return null;
  // 1) STAMP:SID í˜•ì‹
  const m = /^\s*STAMP:([A-Z0-9_-]{2,})\s*$/i.exec(text);
  if (m) return m[1].toUpperCase();
  // 2) URL ë‚´ sid= íŒŒë¼ë¯¸í„°
  try{
    const u = new URL(text);
    const sid = u.searchParams.get('sid');
    if (sid) return sid.toUpperCase();
  }catch(_){ /* not a URL */ }
  // 3) JSON í˜•íƒœ {"sid":"DRONE"}
  try{
    const obj = JSON.parse(text);
    if (obj && obj.sid) return String(obj.sid).toUpperCase();
  }catch(_){ }
  return null;
}

async function sha256Hex(str){
  const enc = new TextEncoder();
  const buf = await crypto.subtle.digest('SHA-256', enc.encode(str));
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}

async function showComplete(){
  // ì™„ì£¼ ì½”ë“œ êµ¬ì„±: ë²„ì „, nonce, ë‚ ì§œ, ìŠ¤í…Œì´ì…˜ ëª©ë¡, ì„œëª…
  const list = [...state.stamps].sort();
  const d = dateKey();
  const payload = `n=${state.nonce};d=${d};s=${list.join(',')}`;
  const sig = (await sha256Hex(`${SALT}|${payload}`)).slice(0,12);
  const code = `COMP1;${payload};h=${sig}`;

  const box = document.getElementById('complete');
  box.style.display = 'block';
  const grid = document.getElementById('stampList');
  grid.innerHTML = '';
  STATIONS.forEach(s=>{
    const div = document.createElement('div');
    div.textContent = `${s.label} ${state.stamps.has(s.id)?'âœ“':''}`;
    grid.appendChild(div);
  });
  document.getElementById('codeText').textContent = code;
  const qrWrap = document.getElementById('codeQr');
  qrWrap.innerHTML = '';
  // QR ìƒì„±
  try{ new QRCode(qrWrap, { text: code, width: 196, height: 196 }); }catch(_){ }
}

function log(msg){ document.getElementById('log').textContent = msg; }

// ===== ìŠ¤ìºë„ˆ ì œì–´ =====
let reader; let currentDeviceId = null;

async function startScan(){
  renderProgress();
  try{
    const devices = await ZXingBrowser.BrowserCodeReader.listVideoInputDevices();
    const back = devices.find(d=>/back|rear|í™˜ê²½|wide|í›„ë©´/i.test(d.label))?.deviceId || devices[0]?.deviceId;
    if (!back) { log('ì¹´ë©”ë¼ ì¥ì¹˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }
    currentDeviceId = back;
    reader = new ZXingBrowser.BrowserMultiFormatReader();
    const video = document.getElementById('preview');
    await reader.decodeFromVideoDevice(currentDeviceId, video, (res, err) => {
      if (res){
        const txt = res.getText();
        const sid = parseStamp(txt);
        if (!sid){ log('ì§€ì›í•˜ì§€ ì•ŠëŠ” QRì…ë‹ˆë‹¤'); return; }
        if (state.stamps.has(sid)){ log('ì´ë¯¸ íšë“í•œ ìŠ¤íƒ¬í”„ì…ë‹ˆë‹¤'); return; }
        // ìœ íš¨ ìŠ¤í…Œì´ì…˜ì¸ì§€ í™•ì¸
        if (!STATIONS.some(s=>s.id===sid)) { log('ì•Œ ìˆ˜ ì—†ëŠ” ìŠ¤í…Œì´ì…˜'); return; }
        state.stamps.add(sid); saveLocal(); renderProgress();
        log(`${sid} íšë“! (${state.stamps.size}/4)`);
        if (state.stamps.size>=4) showComplete();
      }
    });
  }catch(e){
    log('ì¹´ë©”ë¼ ì‚¬ìš©ì´ ê±°ë¶€ë˜ì—ˆê±°ë‚˜ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
  }
}

function stopScan(){
  try{ reader?.reset(); }catch(_){ }
  const v = document.getElementById('preview');
  if (v && v.srcObject){ v.srcObject.getTracks().forEach(t=>t.stop()); v.srcObject=null; }
  log('ìŠ¤ìº” ì¤‘ì§€ë¨');
}

function resetAll(){
  stopScan();
  state.stamps.clear(); saveLocal(); renderProgress();
  document.getElementById('complete').style.display='none';
  log('ì´ ê¸°ê¸°ì˜ ì§„í–‰ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤');
}

// ===== ì´ˆê¸°í™” =====
renderProgress();
window.addEventListener('beforeunload', ()=>{ try{ reader?.reset(); }catch(_){ } });

document.getElementById('startBtn').addEventListener('click', startScan);

document.getElementById('stopBtn').addEventListener('click', stopScan);

document.getElementById('resetBtn').addEventListener('click', resetAll);

// ì´ë¯¸ ì™„ì£¼ ìƒíƒœë©´ í‘œì‹œ
if (state.stamps.size>=4) { showComplete(); }
</script>
</body>
</html>
