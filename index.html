<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ë‹¬ì„œë””ì§€í„¸ì°½ì‘ì„¼í„° ìŠ¤íƒ¬í”„ íˆ¬ì–´ (ì‚¬ìš©ì ì œìŠ¤ì²˜ ë²„ì „)</title>
  <meta name="theme-color" content="#111"/>
  <style>
    :root { --fg:#111; --muted:#6b7280; --bg:#fff; --line:#e5e7eb; --ok:#16a34a; --warn:#f59e0b; --bad:#dc2626;}
    *{box-sizing:border-box} body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:#fff;color:#111}
    header{padding:16px 20px;border-bottom:1px solid var(--line)} h1{margin:0;font-size:20px}
    main{padding:16px}
    .card{border:1px solid var(--line);border-radius:16px;padding:16px;background:#fff;box-shadow:0 1px 6px rgba(0,0,0,.06)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .btn{padding:10px 14px;border-radius:12px;border:1px solid var(--fg);background:var(--fg);color:#fff;cursor:pointer}
    .btn.out{background:#fff;color:var(--fg)}
    .pill{display:inline-block;padding:6px 12px;border-radius:999px;background:#f3f4f6;margin-right:6px}
    .done{background:#e6fbea;color:var(--ok);border:1px solid #86efac}
    video{width:100%;border-radius:12px;background:#000;max-height:48vh}
    .small{font-size:12px;color:var(--muted)}
    .codebox{font-family:ui-monospace,Menlo,Consolas,monospace;background:#111;color:#fff;padding:10px;border-radius:8px;overflow:auto;font-size:12px}
    #banner,#secwarn,#permwarn{display:none;padding:10px;border-radius:12px;margin-bottom:10px}
    #banner{background:#fff7ed;border:1px solid #fed7aa;color:#7c2d12}
    #secwarn{background:#fef2f2;border:1px solid #fecaca;color:#991b1b}
    #permwarn{background:#eff6ff;border:1px solid #bfdbfe;color:#1e40af}
  </style>
  <script src="https://unpkg.com/@zxing/browser@latest"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>
  <div id="banner"></div>
  <header><h1>ìŠ¤íƒ¬í”„ íˆ¬ì–´</h1></header>
  <main>
    <div id="secwarn"></div>
    <div id="permwarn"></div>

    <div class="card">
      <p class="small">íŒë“œë¡  Â· VRë ˆì´ì‹± Â· íœ´ë¨¸ë…¸ì´ë“œ Â· ë°°í‹€ë¡œë´‡ 4ê³³ì„ ëª¨ë‘ ìŠ¤ìº”í•˜ë©´ ì™„ì£¼!</p>
      <div class="row" id="progress" aria-live="polite"></div>
      <div class="row" style="margin-top:8px">
        <button id="btnStart" class="btn" type="button">ì¹´ë©”ë¼ ìŠ¤ìº” ì‹œì‘</button>
        <button id="btnStop" class="btn out" type="button">ì¤‘ì§€</button>
        <button id="btnReset" class="btn out" type="button">ì´ˆê¸°í™”</button>
        <button id="btnPerm" class="btn out" type="button">ê¶Œí•œ í™•ì¸/ìš”ì²­</button>
        <label class="btn out" for="fileInp">ì‚¬ì§„ìœ¼ë¡œ ìŠ¤ìº”</label>
        <input id="fileInp" type="file" accept="image/*" capture="environment" style="display:none"/>
      </div>
      <p class="small" id="notice">â€» ì´ ë²„ì „ì€ <b>ì‚¬ìš©ì í´ë¦­</b>ìœ¼ë¡œë§Œ ì¹´ë©”ë¼ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤. íŒì—…ì´ ì•ˆ ëœ¨ë©´ â€œê¶Œí•œ í™•ì¸/ìš”ì²­â€ì„ ë¨¼ì € ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>
    </div>

    <div class="card" style="margin-top:16px">
      <video id="preview" muted playsinline></video>
      <div id="log" class="small" style="margin-top:8px"></div>
    </div>

    <div id="complete" class="card" style="margin-top:16px;display:none">
      <h2 style="margin:0 0 8px 0">ì™„ì£¼ ì¶•í•˜í•©ë‹ˆë‹¤! ğŸ‰</h2>
      <div id="stampList" style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin:10px 0"></div>
      <div id="codeText" class="codebox"></div>
      <div id="codeQr" style="margin-top:10px"></div>
      <p class="small">ê²€ì¦ í˜ì´ì§€: <a href="verify.html" target="_blank" rel="noopener">verify.html</a></p>
    </div>
  </main>

<script>
// ===== ì„¤ì • =====
const STATIONS=[{id:'DRONE',label:'íŒë“œë¡ '},{id:'VR',label:'VRë ˆì´ì‹±'},{id:'HUMANOID',label:'íœ´ë¨¸ë…¸ì´ë“œ'},{id:'BATTLE',label:'ë°°í‹€ë¡œë´‡'}];
const SALT='CHANGE_ME_SALT_32+CHARS';

// ===== ì•ˆë‚´ ë°°ë„ˆ =====
(function(){
  const ua=navigator.userAgent;
  const inApp=/(KAKAOTALK|FBAN|FBAV|Instagram|Line|NAVER|Whale)/i.test(ua);
  const banner=document.getElementById('banner');
  if(inApp){ banner.style.display='block'; banner.innerHTML='<b>ì•± ë‚´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ì¹´ë©”ë¼ê°€ ì œí•œë  ìˆ˜ ìˆì–´ìš”.</b> â€¢â€¢â€¢ ë©”ë‰´ì—ì„œ ê¸°ë³¸ ë¸Œë¼ìš°ì €(Chrome/Internet/Safari)ë¡œ ì—´ì–´ì£¼ì„¸ìš”.'; }
  const secure=location.protocol==='https:'||location.hostname==='localhost'||location.hostname==='127.0.0.1';
  if(!secure){ const w=document.getElementById('secwarn'); w.style.display='block'; w.textContent=`ì¹´ë©”ë¼ëŠ” HTTPS ë˜ëŠ” localhostì—ì„œë§Œ ë™ì‘í•©ë‹ˆë‹¤. í˜„ì¬: ${location.protocol}//${location.host}`; }
})();

// ===== ìƒíƒœ =====
const state={stamps:new Set(JSON.parse(localStorage.getItem('stamps')||'[]')),nonce:localStorage.getItem('nonce')||null};
if(!state.nonce){ state.nonce=(crypto.getRandomValues(new Uint32Array(4))).join('-'); localStorage.setItem('nonce',state.nonce); }
function save(){ localStorage.setItem('stamps',JSON.stringify([...state.stamps])); }
function dkey(d=new Date()){ return new Intl.DateTimeFormat('ko-KR',{timeZone:'Asia/Seoul'}).format(d).replace(/\./g,'-').replace(/\s/g,'').replace(/-$/,''); }
function log(t){ document.getElementById('log').textContent=t; }

function render(){
  const wrap=document.getElementById('progress'); wrap.innerHTML='';
  STATIONS.forEach(s=>{ const el=document.createElement('span'); el.className='pill'+(state.stamps.has(s.id)?' done':''); el.textContent=s.label+(state.stamps.has(s.id)?' âœ“':''); wrap.appendChild(el); });
}
function parseStamp(text){
  if(!text) return null;
  const m=/^\s*STAMP:([A-Z0-9_-]{2,})\s*$/i.exec(text); if(m) return m[1].toUpperCase();
  try{ const u=new URL(text); const sid=u.searchParams.get('sid'); if(sid) return sid.toUpperCase(); }catch(_){}
  try{ const obj=JSON.parse(text); if(obj&&obj.sid) return String(obj.sid).toUpperCase(); }catch(_){}
  return null;
}
async function sha256Hex(str){ const enc=new TextEncoder(); const buf=await crypto.subtle.digest('SHA-256', enc.encode(str)); return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join(''); }
async function showComplete(){
  const list=[...state.stamps].sort(); const payload=`n=${state.nonce};d=${dkey()};s=${list.join(',')}`;
  const sig=(await sha256Hex(`${SALT}|${payload}`)).slice(0,12);
  const code=`COMP1;${payload};h=${sig}`;
  const box=document.getElementById('complete'); box.style.display='block';
  const grid=document.getElementById('stampList'); grid.innerHTML=''; STATIONS.forEach(s=>{ const d=document.createElement('div'); d.textContent=`${s.label} ${state.stamps.has(s.id)?'âœ“':''}`; grid.appendChild(d); });
  document.getElementById('codeText').textContent=code;
  const qrWrap=document.getElementById('codeQr'); qrWrap.innerHTML=''; try{ new QRCode(qrWrap,{text:code,width:196,height:196}); }catch(_){}
}
function handleText(txt){
  const sid=parseStamp(txt);
  if(!sid){ log('ì§€ì›í•˜ì§€ ì•ŠëŠ” QR/í…ìŠ¤íŠ¸'); return; }
  if(!STATIONS.some(s=>s.id===sid)){ log('ì•Œ ìˆ˜ ì—†ëŠ” ìŠ¤í…Œì´ì…˜'); return; }
  if(state.stamps.has(s.id)){ log('ì´ë¯¸ íšë“í•œ ìŠ¤íƒ¬í”„'); return; }
  state.stamps.add(sid); save(); render(); log(`${sid} íšë“! (${state.stamps.size}/4)`);
  if(state.stamps.size>=4) showComplete();
}

// ===== ê¶Œí•œ í™•ì¸/ìš”ì²­ (ì‚¬ìš©ì ì œìŠ¤ì²˜ í•„ìš” ì—†ìŒ) =====
async function checkPermission(){
  if(!navigator.permissions) return 'unknown';
  try{ const s=await navigator.permissions.query({name:'camera'}); return s.state; }catch(_){ return 'unknown'; }
}
async function requestOnce(){
  try{
    // ì´ í•¨ìˆ˜ëŠ” "ë²„íŠ¼ í´ë¦­"ì—ì„œë§Œ í˜¸ì¶œë©ë‹ˆë‹¤ â†’ íŒì—… íŠ¸ë¦¬ê±° ê°€ëŠ¥
    const stream=await navigator.mediaDevices.getUserMedia({ video:true, audio:false });
    stream.getTracks().forEach(t=>t.stop());
    log('ì¹´ë©”ë¼ ê¶Œí•œ í—ˆìš©ë¨');
    return true;
  }catch(e){
    if(e.name==='NotAllowedError'){ showPermHelp('ì¹´ë©”ë¼ ê¶Œí•œì´ ì°¨ë‹¨ë˜ì–´ ìˆì–´ìš”. ë¸Œë¼ìš°ì €/OS ì„¤ì •ì—ì„œ í—ˆìš© í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.'); }
    else if(e.name==='NotFoundError'){ showPermHelp('ì¹´ë©”ë¼ ì¥ì¹˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); }
    else { showPermHelp('ì¹´ë©”ë¼ ì´ˆê¸°í™” ì˜¤ë¥˜: '+e.message); }
    return false;
  }
}
function showPermHelp(msg){
  const el=document.getElementById('permwarn');
  el.style.display='block';
  el.innerHTML = `<b>ê¶Œí•œ ì•ˆë‚´</b><br>${msg}<br><span class="small">ì‚¼ì„± ì¸í„°ë„·: ì„¤ì • â†’ ì•± â†’ Samsung Internet â†’ ê¶Œí•œ â†’ ì¹´ë©”ë¼ í—ˆìš© / ì•± ë‚´ ì„¤ì • â†’ ì‚¬ì´íŠ¸ ê¶Œí•œ â†’ ì¹´ë©”ë¼ í—ˆìš©</span>`;
}

// ===== ìŠ¤ìºë„ˆ (ì‚¬ìš©ì ì œìŠ¤ì²˜ë¡œë§Œ ì‹œì‘) =====
let reader;
async function startScan(){
  render();
  try{
    reader=new ZXingBrowser.BrowserMultiFormatReader();
    const video=document.getElementById('preview');
    try{
      await reader.decodeFromConstraints({ video:{ facingMode:{ideal:'environment'} } }, video, (res)=>{ if(res) handleText(res.getText()); });
      log('ì¹´ë©”ë¼ ì‹œì‘ë¨');
      return;
    }catch(_){ /* fallback */ }
    const devices=await ZXingBrowser.BrowserCodeReader.listVideoInputDevices();
    const devId=devices[0]?.deviceId;
    if(!devId){ showPermHelp('ì¹´ë©”ë¼ ì¥ì¹˜ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ê¶Œí•œ ìƒíƒœë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.'); return; }
    await reader.decodeFromVideoDevice(devId, video, (res)=>{ if(res) handleText(res.getText()); });
    log('ì¹´ë©”ë¼ ì‹œì‘ë¨(ì¥ì¹˜ ì„ íƒ)');
  }catch(e){
    showPermHelp(e.message||String(e));
  }
}
function stopScan(){ try{ reader?.reset(); }catch(_){ } const v=document.getElementById('preview'); if(v&&v.srcObject){ v.srcObject.getTracks().forEach(t=>t.stop()); v.srcObject=null; } log('ìŠ¤ìº” ì¤‘ì§€ë¨'); }

// ===== ì‚¬ì§„ìœ¼ë¡œ ìŠ¤ìº”(ê¶Œí•œë¶ˆí•„ìš”) =====
document.getElementById('fileInp').addEventListener('change', async (ev)=>{
  const f=ev.target.files?.[0]; if(!f) return;
  const url=URL.createObjectURL(f);
  try{
    if('BarcodeDetector' in window){
      const det=new BarcodeDetector({formats:['qr_code']});
      const bmp=await createImageBitmap(await (await fetch(url)).blob());
      const codes=await det.detect(bmp);
      if(codes.length){ handleText(codes[0].rawValue); return; }
    }
    const r=new ZXingBrowser.BrowserMultiFormatReader();
    const res=await r.decodeFromImageUrl(url);
    handleText(res.getText());
  }catch(e){ log('ì‚¬ì§„ ì¸ì‹ ì‹¤íŒ¨: '+(e.message||e)); }
  finally{ URL.revokeObjectURL(url); ev.target.value=''; }
});

// ===== ì´ë²¤íŠ¸: ìë™ ì‹œì‘ì€ í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤ =====
render();
document.getElementById('btnStart').addEventListener('click', async ()=>{
  // ì‚¬ìš©ì ì œìŠ¤ì²˜ ì•ˆì—ì„œ ê¶Œí•œì„ ì§ì ‘ ìš”ì²­ â†’ íŒì—… í‘œì‹œ ê°€ëŠ¥
  const st = await checkPermission();
  if (st === 'denied') { showPermHelp('ë¸Œë¼ìš°ì €ì—ì„œ ì¹´ë©”ë¼ê°€ ì°¨ë‹¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ì‚¬ì´íŠ¸ ê¶Œí•œì—ì„œ í—ˆìš©ìœ¼ë¡œ ë°”ê¾¸ê³  ìƒˆë¡œê³ ì¹¨í•˜ì„¸ìš”.'); return; }
  if (st !== 'granted') { const ok = await requestOnce(); if (!ok) return; }
  await startScan();
});
document.getElementById('btnStop').addEventListener('click', stopScan);
document.getElementById('btnReset').addEventListener('click', ()=>{ stopScan(); state.stamps.clear(); save(); render(); document.getElementById('complete').style.display='none'; log('ì´ˆê¸°í™”ë¨'); });
document.getElementById('btnPerm').addEventListener('click', requestOnce);
if(state.stamps.size>=4){ showComplete(); }
</script>
</body>
</html>
