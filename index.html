<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>달서디지털창작센터 스탬프 투어 (사용자 제스처 버전)</title>
  <meta name="theme-color" content="#111"/>
  <style>
    :root { --fg:#111; --muted:#6b7280; --bg:#fff; --line:#e5e7eb; --ok:#16a34a; --warn:#f59e0b; --bad:#dc2626;}
    *{box-sizing:border-box} body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:#fff;color:#111}
    header{padding:16px 20px;border-bottom:1px solid var(--line)} h1{margin:0;font-size:20px}
    main{padding:16px}
    .card{border:1px solid var(--line);border-radius:16px;padding:16px;background:#fff;box-shadow:0 1px 6px rgba(0,0,0,.06)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .btn{padding:10px 14px;border-radius:12px;border:1px solid var(--fg);background:var(--fg);color:#fff;cursor:pointer}
    .btn.out{background:#fff;color:var(--fg)}
    .pill{display:inline-block;padding:6px 12px;border-radius:999px;background:#f3f4f6;margin-right:6px}
    .done{background:#e6fbea;color:var(--ok);border:1px solid #86efac}
    video{width:100%;border-radius:12px;background:#000;max-height:48vh}
    .small{font-size:12px;color:var(--muted)}
    .codebox{font-family:ui-monospace,Menlo,Consolas,monospace;background:#111;color:#fff;padding:10px;border-radius:8px;overflow:auto;font-size:12px}
    #banner,#secwarn,#permwarn{display:none;padding:10px;border-radius:12px;margin-bottom:10px}
    #banner{background:#fff7ed;border:1px solid #fed7aa;color:#7c2d12}
    #secwarn{background:#fef2f2;border:1px solid #fecaca;color:#991b1b}
    #permwarn{background:#eff6ff;border:1px solid #bfdbfe;color:#1e40af}
  </style>
  <script src="https://unpkg.com/@zxing/browser@latest"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>
  <div id="banner"></div>
  <header><h1>스탬프 투어</h1></header>
  <main>
    <div id="secwarn"></div>
    <div id="permwarn"></div>

    <div class="card">
      <p class="small">팝드론 · VR레이싱 · 휴머노이드 · 배틀로봇 4곳을 모두 스캔하면 완주!</p>
      <div class="row" id="progress" aria-live="polite"></div>
      <div class="row" style="margin-top:8px">
        <button id="btnStart" class="btn" type="button">카메라 스캔 시작</button>
        <button id="btnStop" class="btn out" type="button">중지</button>
        <button id="btnReset" class="btn out" type="button">초기화</button>
        <button id="btnPerm" class="btn out" type="button">권한 확인/요청</button>
        <label class="btn out" for="fileInp">사진으로 스캔</label>
        <input id="fileInp" type="file" accept="image/*" capture="environment" style="display:none"/>
      </div>
      <p class="small" id="notice">※ 이 버전은 <b>사용자 클릭</b>으로만 카메라를 시작합니다. 팝업이 안 뜨면 “권한 확인/요청”을 먼저 눌러주세요.</p>
    </div>

    <div class="card" style="margin-top:16px">
      <video id="preview" muted playsinline></video>
      <div id="log" class="small" style="margin-top:8px"></div>
    </div>

    <div id="complete" class="card" style="margin-top:16px;display:none">
      <h2 style="margin:0 0 8px 0">완주 축하합니다! 🎉</h2>
      <div id="stampList" style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin:10px 0"></div>
      <div id="codeText" class="codebox"></div>
      <div id="codeQr" style="margin-top:10px"></div>
      <p class="small">검증 페이지: <a href="verify.html" target="_blank" rel="noopener">verify.html</a></p>
    </div>
  </main>

<script>
// ===== 설정 =====
const STATIONS=[{id:'DRONE',label:'팝드론'},{id:'VR',label:'VR레이싱'},{id:'HUMANOID',label:'휴머노이드'},{id:'BATTLE',label:'배틀로봇'}];
const SALT='CHANGE_ME_SALT_32+CHARS';

// ===== 안내 배너 =====
(function(){
  const ua=navigator.userAgent;
  const inApp=/(KAKAOTALK|FBAN|FBAV|Instagram|Line|NAVER|Whale)/i.test(ua);
  const banner=document.getElementById('banner');
  if(inApp){ banner.style.display='block'; banner.innerHTML='<b>앱 내 브라우저에서는 카메라가 제한될 수 있어요.</b> ••• 메뉴에서 기본 브라우저(Chrome/Internet/Safari)로 열어주세요.'; }
  const secure=location.protocol==='https:'||location.hostname==='localhost'||location.hostname==='127.0.0.1';
  if(!secure){ const w=document.getElementById('secwarn'); w.style.display='block'; w.textContent=`카메라는 HTTPS 또는 localhost에서만 동작합니다. 현재: ${location.protocol}//${location.host}`; }
})();

// ===== 상태 =====
const state={stamps:new Set(JSON.parse(localStorage.getItem('stamps')||'[]')),nonce:localStorage.getItem('nonce')||null};
if(!state.nonce){ state.nonce=(crypto.getRandomValues(new Uint32Array(4))).join('-'); localStorage.setItem('nonce',state.nonce); }
function save(){ localStorage.setItem('stamps',JSON.stringify([...state.stamps])); }
function dkey(d=new Date()){ return new Intl.DateTimeFormat('ko-KR',{timeZone:'Asia/Seoul'}).format(d).replace(/\./g,'-').replace(/\s/g,'').replace(/-$/,''); }
function log(t){ document.getElementById('log').textContent=t; }

function render(){
  const wrap=document.getElementById('progress'); wrap.innerHTML='';
  STATIONS.forEach(s=>{ const el=document.createElement('span'); el.className='pill'+(state.stamps.has(s.id)?' done':''); el.textContent=s.label+(state.stamps.has(s.id)?' ✓':''); wrap.appendChild(el); });
}
function parseStamp(text){
  if(!text) return null;
  const m=/^\s*STAMP:([A-Z0-9_-]{2,})\s*$/i.exec(text); if(m) return m[1].toUpperCase();
  try{ const u=new URL(text); const sid=u.searchParams.get('sid'); if(sid) return sid.toUpperCase(); }catch(_){}
  try{ const obj=JSON.parse(text); if(obj&&obj.sid) return String(obj.sid).toUpperCase(); }catch(_){}
  return null;
}
async function sha256Hex(str){ const enc=new TextEncoder(); const buf=await crypto.subtle.digest('SHA-256', enc.encode(str)); return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join(''); }
async function showComplete(){
  const list=[...state.stamps].sort(); const payload=`n=${state.nonce};d=${dkey()};s=${list.join(',')}`;
  const sig=(await sha256Hex(`${SALT}|${payload}`)).slice(0,12);
  const code=`COMP1;${payload};h=${sig}`;
  const box=document.getElementById('complete'); box.style.display='block';
  const grid=document.getElementById('stampList'); grid.innerHTML=''; STATIONS.forEach(s=>{ const d=document.createElement('div'); d.textContent=`${s.label} ${state.stamps.has(s.id)?'✓':''}`; grid.appendChild(d); });
  document.getElementById('codeText').textContent=code;
  const qrWrap=document.getElementById('codeQr'); qrWrap.innerHTML=''; try{ new QRCode(qrWrap,{text:code,width:196,height:196}); }catch(_){}
}
function handleText(txt){
  const sid=parseStamp(txt);
  if(!sid){ log('지원하지 않는 QR/텍스트'); return; }
  if(!STATIONS.some(s=>s.id===sid)){ log('알 수 없는 스테이션'); return; }
  if(state.stamps.has(s.id)){ log('이미 획득한 스탬프'); return; }
  state.stamps.add(sid); save(); render(); log(`${sid} 획득! (${state.stamps.size}/4)`);
  if(state.stamps.size>=4) showComplete();
}

// ===== 권한 확인/요청 (사용자 제스처 필요 없음) =====
async function checkPermission(){
  if(!navigator.permissions) return 'unknown';
  try{ const s=await navigator.permissions.query({name:'camera'}); return s.state; }catch(_){ return 'unknown'; }
}
async function requestOnce(){
  try{
    // 이 함수는 "버튼 클릭"에서만 호출됩니다 → 팝업 트리거 가능
    const stream=await navigator.mediaDevices.getUserMedia({ video:true, audio:false });
    stream.getTracks().forEach(t=>t.stop());
    log('카메라 권한 허용됨');
    return true;
  }catch(e){
    if(e.name==='NotAllowedError'){ showPermHelp('카메라 권한이 차단되어 있어요. 브라우저/OS 설정에서 허용 후 다시 시도해 주세요.'); }
    else if(e.name==='NotFoundError'){ showPermHelp('카메라 장치를 찾을 수 없습니다.'); }
    else { showPermHelp('카메라 초기화 오류: '+e.message); }
    return false;
  }
}
function showPermHelp(msg){
  const el=document.getElementById('permwarn');
  el.style.display='block';
  el.innerHTML = `<b>권한 안내</b><br>${msg}<br><span class="small">삼성 인터넷: 설정 → 앱 → Samsung Internet → 권한 → 카메라 허용 / 앱 내 설정 → 사이트 권한 → 카메라 허용</span>`;
}

// ===== 스캐너 (사용자 제스처로만 시작) =====
let reader;
async function startScan(){
  render();
  try{
    reader=new ZXingBrowser.BrowserMultiFormatReader();
    const video=document.getElementById('preview');
    try{
      await reader.decodeFromConstraints({ video:{ facingMode:{ideal:'environment'} } }, video, (res)=>{ if(res) handleText(res.getText()); });
      log('카메라 시작됨');
      return;
    }catch(_){ /* fallback */ }
    const devices=await ZXingBrowser.BrowserCodeReader.listVideoInputDevices();
    const devId=devices[0]?.deviceId;
    if(!devId){ showPermHelp('카메라 장치를 찾지 못했습니다. 권한 상태를 확인해 주세요.'); return; }
    await reader.decodeFromVideoDevice(devId, video, (res)=>{ if(res) handleText(res.getText()); });
    log('카메라 시작됨(장치 선택)');
  }catch(e){
    showPermHelp(e.message||String(e));
  }
}
function stopScan(){ try{ reader?.reset(); }catch(_){ } const v=document.getElementById('preview'); if(v&&v.srcObject){ v.srcObject.getTracks().forEach(t=>t.stop()); v.srcObject=null; } log('스캔 중지됨'); }

// ===== 사진으로 스캔(권한불필요) =====
document.getElementById('fileInp').addEventListener('change', async (ev)=>{
  const f=ev.target.files?.[0]; if(!f) return;
  const url=URL.createObjectURL(f);
  try{
    if('BarcodeDetector' in window){
      const det=new BarcodeDetector({formats:['qr_code']});
      const bmp=await createImageBitmap(await (await fetch(url)).blob());
      const codes=await det.detect(bmp);
      if(codes.length){ handleText(codes[0].rawValue); return; }
    }
    const r=new ZXingBrowser.BrowserMultiFormatReader();
    const res=await r.decodeFromImageUrl(url);
    handleText(res.getText());
  }catch(e){ log('사진 인식 실패: '+(e.message||e)); }
  finally{ URL.revokeObjectURL(url); ev.target.value=''; }
});

// ===== 이벤트: 자동 시작은 하지 않습니다 =====
render();
document.getElementById('btnStart').addEventListener('click', async ()=>{
  // 사용자 제스처 안에서 권한을 직접 요청 → 팝업 표시 가능
  const st = await checkPermission();
  if (st === 'denied') { showPermHelp('브라우저에서 카메라가 차단되어 있습니다. 사이트 권한에서 허용으로 바꾸고 새로고침하세요.'); return; }
  if (st !== 'granted') { const ok = await requestOnce(); if (!ok) return; }
  await startScan();
});
document.getElementById('btnStop').addEventListener('click', stopScan);
document.getElementById('btnReset').addEventListener('click', ()=>{ stopScan(); state.stamps.clear(); save(); render(); document.getElementById('complete').style.display='none'; log('초기화됨'); });
document.getElementById('btnPerm').addEventListener('click', requestOnce);
if(state.stamps.size>=4){ showComplete(); }
</script>
</body>
</html>
