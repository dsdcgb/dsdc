<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>달서디지털창작센터 스탬프 투어</title>
  <meta name="theme-color" content="#111"/>
  <style>
    :root { --fg:#111; --muted:#6b7280; --bg:#fff; --line:#e5e7eb; --ok:#16a34a; }
    *{box-sizing:border-box} body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:var(--bg);color:var(--fg)}
    header{padding:16px 20px;border-bottom:1px solid var(--line)}
    h1{margin:0;font-size:20px}
    main{padding:16px}
    .card{border:1px solid var(--line);border-radius:16px;padding:16px;box-shadow:0 1px 6px rgba(0,0,0,.06);background:#fff}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .btn{padding:12px 16px;border-radius:12px;border:1px solid var(--fg);cursor:pointer;background:var(--fg);color:#fff}
    .btn.outline{background:#fff;color:var(--fg)}
    .pill{display:inline-block;padding:6px 12px;border-radius:999px;background:#f3f4f6;margin-right:6px}
    .done{background:#e6fbea;color:var(--ok);border:1px solid #86efac}
    .muted{color:var(--muted)}
    video{width:100%;border-radius:12px;background:#000;max-height:48vh}
    #complete{border:2px solid var(--ok)}
    .codebox{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;background:#111;color:#fff;padding:10px;border-radius:8px;overflow:auto}
    .small{font-size:12px}
    .grid2{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    a.link{color:#2563eb;text-decoration:none}
  </style>
  <!-- QR 스캔 라이브러리 -->
  <script src="https://unpkg.com/@zxing/browser@latest"></script>
  <!-- 완주코드 QR 생성용 (선택) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>
  <header>
    <h1>스탬프 투어</h1>
  </header>
  <main>
    <div class="card">
      <p class="muted">팝드론 · VR레이싱 · 휴머노이드 · 배틀로봇 4곳을 모두 스캔하면 완주!</p>
      <div id="progress" class="row" aria-live="polite"></div>
      <div class="row" style="margin-top:8px">
        <button id="startBtn" class="btn" type="button">카메라 스캔 시작</button>
        <button id="stopBtn" class="btn outline" type="button">중지</button>
        <button id="resetBtn" class="btn outline small" type="button" title="이 기기의 진행을 초기화합니다">초기화</button>
      </div>
      <p id="notice" class="muted small" style="margin-top:6px">스캔하려면 시작 버튼을 누르고, 각 체험존의 QR을 비춰주세요.</p>
    </div>

    <div class="card" style="margin-top:16px">
      <video id="preview" muted playsinline></video>
      <div id="log" class="muted" style="margin-top:8px"></div>
    </div>

    <div id="complete" class="card" style="margin-top:16px;display:none">
      <h2 style="margin-top:0">완주 축하합니다! 🎉</h2>
      <div id="stampList" class="grid2" style="margin:10px 0"></div>
      <p class="muted small">아래의 완주코드를 안내데스크에 제시해 주세요.</p>
      <div id="codeText" class="codebox small" style="margin-top:8px"></div>
      <div id="codeQr" style="margin-top:10px"></div>
      <p class="small" style="margin-top:8px">검증 페이지: <a class="link" href="verify.html" target="_blank" rel="noopener">verify.html</a></p>
    </div>
  </main>

<script>
// ===== 설정 =====
const STATIONS = [
  { id:'DRONE', label:'팝드론' },
  { id:'VR', label:'VR레이싱' },
  { id:'HUMANOID', label:'휴머노이드' },
  { id:'BATTLE', label:'배틀로봇' },
];
const SALT = 'CHANGE_ME_SALT_32+CHARS'; // 배포 전에 임의로 변경하세요(두 페이지 동일값)

// ===== 상태 및 유틸 =====
const state = {
  stamps: new Set(JSON.parse(localStorage.getItem('stamps')||'[]')),
  nonce: localStorage.getItem('nonce') || null,
};
if (!state.nonce){
  state.nonce = crypto.getRandomValues(new Uint32Array(4)).join('-');
  localStorage.setItem('nonce', state.nonce);
}

function saveLocal(){ localStorage.setItem('stamps', JSON.stringify([...state.stamps])); }
function dateKey(d=new Date()){ return new Intl.DateTimeFormat('ko-KR',{timeZone:'Asia/Seoul'}).format(d).replace(/\./g,'-').replace(/\s/g,'').replace(/-$/,''); }

function renderProgress(){
  const wrap = document.getElementById('progress');
  wrap.innerHTML = '';
  STATIONS.forEach(s=>{
    const el = document.createElement('span');
    el.className = 'pill' + (state.stamps.has(s.id) ? ' done' : '') ;
    el.textContent = s.label + (state.stamps.has(s.id)?' ✓':'');
    wrap.appendChild(el);
  });
}

function parseStamp(text){
  if (!text) return null;
  // 1) STAMP:SID 형식
  const m = /^\s*STAMP:([A-Z0-9_-]{2,})\s*$/i.exec(text);
  if (m) return m[1].toUpperCase();
  // 2) URL 내 sid= 파라미터
  try{
    const u = new URL(text);
    const sid = u.searchParams.get('sid');
    if (sid) return sid.toUpperCase();
  }catch(_){ /* not a URL */ }
  // 3) JSON 형태 {"sid":"DRONE"}
  try{
    const obj = JSON.parse(text);
    if (obj && obj.sid) return String(obj.sid).toUpperCase();
  }catch(_){ }
  return null;
}

async function sha256Hex(str){
  const enc = new TextEncoder();
  const buf = await crypto.subtle.digest('SHA-256', enc.encode(str));
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}

async function showComplete(){
  // 완주 코드 구성: 버전, nonce, 날짜, 스테이션 목록, 서명
  const list = [...state.stamps].sort();
  const d = dateKey();
  const payload = `n=${state.nonce};d=${d};s=${list.join(',')}`;
  const sig = (await sha256Hex(`${SALT}|${payload}`)).slice(0,12);
  const code = `COMP1;${payload};h=${sig}`;

  const box = document.getElementById('complete');
  box.style.display = 'block';
  const grid = document.getElementById('stampList');
  grid.innerHTML = '';
  STATIONS.forEach(s=>{
    const div = document.createElement('div');
    div.textContent = `${s.label} ${state.stamps.has(s.id)?'✓':''}`;
    grid.appendChild(div);
  });
  document.getElementById('codeText').textContent = code;
  const qrWrap = document.getElementById('codeQr');
  qrWrap.innerHTML = '';
  // QR 생성
  try{ new QRCode(qrWrap, { text: code, width: 196, height: 196 }); }catch(_){ }
}

function log(msg){ document.getElementById('log').textContent = msg; }

// ===== 스캐너 제어 =====
let reader; let currentDeviceId = null;

async function startScan(){
  renderProgress();
  try{
    const devices = await ZXingBrowser.BrowserCodeReader.listVideoInputDevices();
    const back = devices.find(d=>/back|rear|환경|wide|후면/i.test(d.label))?.deviceId || devices[0]?.deviceId;
    if (!back) { log('카메라 장치를 찾을 수 없습니다.'); return; }
    currentDeviceId = back;
    reader = new ZXingBrowser.BrowserMultiFormatReader();
    const video = document.getElementById('preview');
    await reader.decodeFromVideoDevice(currentDeviceId, video, (res, err) => {
      if (res){
        const txt = res.getText();
        const sid = parseStamp(txt);
        if (!sid){ log('지원하지 않는 QR입니다'); return; }
        if (state.stamps.has(sid)){ log('이미 획득한 스탬프입니다'); return; }
        // 유효 스테이션인지 확인
        if (!STATIONS.some(s=>s.id===sid)) { log('알 수 없는 스테이션'); return; }
        state.stamps.add(sid); saveLocal(); renderProgress();
        log(`${sid} 획득! (${state.stamps.size}/4)`);
        if (state.stamps.size>=4) showComplete();
      }
    });
  }catch(e){
    log('카메라 사용이 거부되었거나 지원되지 않습니다.');
  }
}

function stopScan(){
  try{ reader?.reset(); }catch(_){ }
  const v = document.getElementById('preview');
  if (v && v.srcObject){ v.srcObject.getTracks().forEach(t=>t.stop()); v.srcObject=null; }
  log('스캔 중지됨');
}

function resetAll(){
  stopScan();
  state.stamps.clear(); saveLocal(); renderProgress();
  document.getElementById('complete').style.display='none';
  log('이 기기의 진행이 초기화되었습니다');
}

// ===== 초기화 =====
renderProgress();
window.addEventListener('beforeunload', ()=>{ try{ reader?.reset(); }catch(_){ } });

document.getElementById('startBtn').addEventListener('click', startScan);

document.getElementById('stopBtn').addEventListener('click', stopScan);

document.getElementById('resetBtn').addEventListener('click', resetAll);

// 이미 완주 상태면 표시
if (state.stamps.size>=4) { showComplete(); }
</script>
</body>
</html>
